<div class="game-container">
  <h1 class="title">üê± –ü–æ–π–º–∞–π –∫–æ—Ç–∞!</h1>
  <h1 class="title">–ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞ –ò–ª—å–∏—á–µ–≤ –ò.–î</h1>
  
  <div class="game-info">
    <div class="score" style="display: none;">–°—á–µ—Ç: <span id="score"><%= @score %></span></div>
    <div class="moves" style="display: none;">–•–æ–¥: <span id="moves"><%= @moves %></span></div>
    <div class="message" id="message" style="display: none;"></div>
    <button onclick="newGame()" class="btn-new">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
  </div>
  
  <div class="game-board" id="game-board">
    <%= for y <- 0..(@grid_size-1) do %>
      <div class="row">
        <%= for x <- 0..(@grid_size-1) do %>
          <div class="cell" 
               data-x={x}
               data-y={y} 
               onclick="makeMove(this)"
               id={"cell-#{x}-#{y}"}>
            <%= cond do %>
              <% {x, y} == @cat_position -> %>
                <div class="cat">üê±</div>
              <% MapSet.member?(@blocks, {x, y}) -> %>
                <div class="block">‚¨õ</div>
              <% true -> %>
                <div class="empty"></div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

</div>

<script>
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∏–≥—Ä—ã
  const gameId = "<%= @game_id %>";
  let gameOver = <%= @game_over %>;
  
  function makeMove(cell) {
    if (gameOver) return;
    
    const x = cell.getAttribute('data-x');
    const y = cell.getAttribute('data-y');
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
    cell.style.pointerEvents = 'none';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/move', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        game_id: gameId,
        x: x,
        y: y
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateGame(data);
      } else {
        alert('–û—à–∏–±–∫–∞: ' + data.error);
      }
      // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      cell.style.pointerEvents = 'auto';
    })
    .catch(error => {
      console.error('Error:', error);
      alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
      cell.style.pointerEvents = 'auto';
    });
  }
  
  function updateGame(data) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç –∏ —Ö–æ–¥—ã
    document.getElementById('score').textContent = data.score;
    document.getElementById('moves').textContent = data.moves;
    document.getElementById('message').textContent = data.message;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º gameOver –∏–∑ –¥–∞–Ω–Ω—ã—Ö
    gameOver = data.game_over;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ
    const gridSize = <%= @grid_size %>;
    const catPos = data.cat_position;
    const blocks = new Set(data.blocks.map(b => `${b[0]},${b[1]}`));
    
    for(let y = 0; y < gridSize; y++) {
      for(let x = 0; x < gridSize; x++) {
        const cell = document.getElementById(`cell-${x}-${y}`);
        const content = cell.querySelector('div');
        
        if(x === catPos[0] && y === catPos[1]) {
          content.className = 'cat';
          content.textContent = 'üê±';
        } else if(blocks.has(`${x},${y}`)) {
          content.className = 'block';
          content.textContent = '‚¨õ';
        } else {
          content.className = 'empty';
          content.textContent = '';
        }
      }
    }
    
    // –ï—Å–ª–∏ –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
    if(data.game_over) {
      setTimeout(() => {
        if(data.message.includes('–ø–æ–π–º–∞–ª–∏')) {
          alert('üéâ –ü–æ–±–µ–¥–∞! ' + data.message);
        } else {
          alert('üòø ' + data.message);
        }
      }, 100);
    }
  }
  
  function newGame() {
    window.location.reload();
  }
</script>