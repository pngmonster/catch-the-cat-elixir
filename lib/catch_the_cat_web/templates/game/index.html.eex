<div class="game-container">
  <h1 class="title">üê± –ü–æ–π–º–∞–π –∫–æ—Ç–∞!</h1>
  
  <div class="game-info">
    <div class="score">–°—á–µ—Ç: <span id="score"><%= @score %></span></div>
    <div class="moves">–•–æ–¥: <span id="moves"><%= @moves %></span></div>
    <div class="message" id="message"></div>
    <button onclick="newGame()" class="btn-new">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
  </div>
  
  <div class="game-board" id="game-board">
    <%= for y <- 0..(@grid_size-1) do %>
      <div class="row">
        <%= for x <- 0..(@grid_size-1) do %>
          <div class="cell" 
               data-x="<%= x %>" 
               data-y="<%= y %>"
               onclick="makeMove(this)"
               id="cell-<%= x %>-<%= y %>">
            <%= if {x, y} == @cat_position do %>
              <div class="cat">üê±</div>
            <% else if MapSet.member?(@blocks, {x, y}) do %>
              <div class="block">‚¨õ</div>
            <% else %>
              <div class="empty"></div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
  
  <div class="instructions">
    <h3>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</h3>
    <p>1. –ö–ª–∏–∫–∞–π –ø–æ –∫–ª–µ—Ç–∫–∞–º, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫–∏ üß±</p>
    <p>2. –¶–µ–ª—å: –æ–∫—Ä—É–∂–∏—Ç—å –∫–æ—Ç–∞ —Å–æ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–Ω</p>
    <p>3. –ö–æ—Ç –ø—ã—Ç–∞–µ—Ç—Å—è —É–±–µ–∂–∞—Ç—å –∫ –∫—Ä–∞—é –ø–æ–ª—è</p>
    <p>4. –ö–∞–∂–¥—ã–π —Ö–æ–¥ –∫–æ—Ç–∞ —É–º–µ–Ω—å—à–∞–µ—Ç —Ç–≤–æ–π —Å—á–µ—Ç</p>
  </div>
</div>

<script>
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∏–≥—Ä—ã
  const gameId = "<%= @game_id %>";
  
  function makeMove(cell) {
    if (<%= @game_over %>) return;
    
    const x = cell.getAttribute('data-x');
    const y = cell.getAttribute('data-y');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/move', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        game_id: gameId,
        x: x,
        y: y
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateGame(data);
      } else {
        alert('–û—à–∏–±–∫–∞: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    });
  }
  
  function updateGame(data) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç –∏ —Ö–æ–¥—ã
    document.getElementById('score').textContent = data.score;
    document.getElementById('moves').textContent = data.moves;
    document.getElementById('message').textContent = data.message;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ
    const gridSize = <%= @grid_size %>;
    const catPos = data.cat_position;
    const blocks = new Set(data.blocks.map(b => `${b[0]},${b[1]}`));
    
    for(let y = 0; y < gridSize; y++) {
      for(let x = 0; x < gridSize; x++) {
        const cell = document.getElementById(`cell-${x}-${y}`);
        const content = cell.querySelector('div');
        
        if(x === catPos[0] && y === catPos[1]) {
          content.className = 'cat';
          content.textContent = 'üê±';
        } else if(blocks.has(`${x},${y}`)) {
          content.className = 'block';
          content.textContent = '‚¨õ';
        } else {
          content.className = 'empty';
          content.textContent = '';
        }
      }
    }
    
    // –ï—Å–ª–∏ –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
    if(data.game_over) {
      setTimeout(() => {
        if(data.message.includes('–ø–æ–π–º–∞–ª–∏')) {
          alert('üéâ –ü–æ–±–µ–¥–∞! ' + data.message);
        } else {
          alert('üòø ' + data.message);
        }
      }, 100);
    }
  }
  
  function newGame() {
    window.location.reload();
  }
</script>